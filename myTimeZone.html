<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>My Time Zone</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 1em;
      text-align: center;
    }

    h1 {
      margin-top: 0;
    }

    .form-group {
      margin-bottom: 1em;
    }

    label {
      display: inline-block;
      width: 180px;
      text-align: right;
      margin-right: 8px;
    }

    input[type="time"],
    input[type="text"],
    textarea {
      width: 160px;
      padding: 0.3em;
      font-size: 1rem;
    }

    button {
      padding: 0.5em 1em;
      font-size: 1rem;
      cursor: pointer;
      margin: 0.5em 0.2em;
    }

    #clock {
      font-size: 3.5rem;
      font-weight: bold;
      margin: 20pt 0;
    }

    #offsetStatus {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1em;
    }

    .instruction {
      font-size: 0.9rem;
      color: #666;
      margin: 1em 0;
      line-height: 1.4;
    }

    .row {
      margin-top: 1em;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="clock"></div>
    <div id="offsetStatus">シフトなし</div>

    <div class="form-group">
      <label for="startOffsetTime">開始 (HH:MM)</label>
      <input type="time" id="startOffsetTime" value="15:00">
    </div>

    <div class="form-group">
      <label for="resetOffsetTime">解除 (HH:MM)</label>
      <input type="time" id="resetOffsetTime" value="03:00">
    </div>

    <div class="form-group">
      <label for="offsetTime">ずらす幅 (HH:MM:SS)</label>
      <input type="text" id="offsetTime" value="01:30:00">
    </div>

    <div class="instruction">
      <p>
        シフトが有効になる開始時刻と解除時刻、
        そしてシフト幅を設定してください。
      </p>
      <p>
        設定後「設定を反映」をクリックすると、URLに反映されます。
      </p>
    </div>

    <div class="row">
      <button id="updateURLButton">設定を反映</button>
    </div>
    <div class="form-group">
      <textarea id="url" rows="2" readonly></textarea>
    </div>
    <div class="row">
      <button id="copyURLButton">URLをコピー</button>
    </div>
  </div>

  <script>
    // 時刻文字列「HH:MM」をパースして [h, m] の配列を返す
    const parseHHMM = (timeString) => {
      if (!timeString || !timeString.includes(':')) return [0, 0];
      const [h, m] = timeString.split(':').map(num => parseInt(num, 10) || 0);
      return [h, m];
    };

    // 時刻文字列「HH:MM:SS」をパースして [h, m, s] の配列を返す
    const parseHHMMSS = (timeString) => {
      if (!timeString || !timeString.includes(':')) return [0, 0, 0];
      const [h, m, s] = timeString.split(':').map(num => parseInt(num, 10) || 0);
      return [h, m, s];
    };

    // 時刻を更新して画面に表示する
    const updateTime = () => {
      const startOffsetTimeValue = startOffsetTime.value; // "HH:MM"
      const resetOffsetTimeValue = resetOffsetTime.value; // "HH:MM"
      const offsetTimeValue = offsetTime.value;      // "HH:MM:SS"
      const [startH, startM] = parseHHMM(startOffsetTimeValue);
      const [resetH, resetM] = parseHHMM(resetOffsetTimeValue);
      const [offsetH, offsetM, offsetS] = parseHHMMSS(offsetTimeValue);
      const offsetInSeconds = offsetH * 3600 + offsetM * 60 + offsetS;

      const now = new Date();
      const options = { timeZone: 'Asia/Tokyo', hour12: false };
      const jstString = now.toLocaleString('en-GB', options);
      const [, timePart] = jstString.split(', ');
      let [currentHour, currentMinute, currentSecond] = timePart.split(':').map(Number);

      const currentTotalMinutes = currentHour * 60 + currentMinute;
      const currentTotalSeconds = currentHour * 3600 + currentMinute * 60 + currentSecond;
      const startOffsetTotalMinutes = startH * 60 + startM;
      const resetOffsetTotalMinutes = resetH * 60 + resetM;

      // (A) 同日内で完結 (start <= reset)
      // (B) 日付をまたぐ (start > reset) で判定
      let isOffsetTime = false;
      if (startOffsetTotalMinutes <= resetOffsetTotalMinutes) {
        if (currentTotalMinutes >= startOffsetTotalMinutes &&
          currentTotalMinutes < resetOffsetTotalMinutes) {
          isOffsetTime = true;
        }
      } else {
        if (currentTotalMinutes >= startOffsetTotalMinutes ||
          currentTotalMinutes < resetOffsetTotalMinutes) {
          isOffsetTime = true;
        }
      }

      let displayTotalSeconds = currentTotalSeconds;
      if (isOffsetTime) {
        displayTotalSeconds += offsetInSeconds;
      }
      displayTotalSeconds = (displayTotalSeconds % 86400 + 86400) % 86400;

      const dispHour = Math.floor(displayTotalSeconds / 3600);
      const dispMinute = Math.floor((displayTotalSeconds % 3600) / 60);
      const dispSecond = displayTotalSeconds % 60;
      const hh = String(dispHour).padStart(2, '0');
      const mm = String(dispMinute).padStart(2, '0');
      const ss = String(dispSecond).padStart(2, '0');

      clock.textContent = `${hh}:${mm}:${ss}`;
      offsetStatus.textContent = isOffsetTime
        ? `シフト中：日本時間 + ${offsetTimeValue}`
        : 'シフトなし';
    };

    // URLパラメータを読み込み、各入力フォームに反映
    const loadParamsFromURL = () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('start')) startOffsetTime.value = params.get('start');
      if (params.has('reset')) resetOffsetTime.value = params.get('reset');
      if (params.has('offset')) offsetTime.value = params.get('offset');
    };

    // 入力項目からURLを更新して表示
    const updateURL = () => {
      const params = new URLSearchParams();
      params.set('start', startOffsetTime.value);
      params.set('reset', resetOffsetTime.value);
      params.set('offset', offsetTime.value);

      const newUrl = `${window.location.origin}${window.location.pathname}?${params}`;
      url.value = newUrl;
      history.replaceState({}, '', newUrl);
      updateTime();
    };

    // URLをクリップボードにコピー
    const copyURL = async () => {
      try {
        await navigator.clipboard.writeText(url.value);
        alert('URLをコピーしました');
      } catch (err) {
        console.error('コピーエラー', err);
      }
    };

    // DOM読み込み後の初期処理
    document.addEventListener('DOMContentLoaded', () => {
      window.startOffsetTime = document.getElementById('startOffsetTime');
      window.resetOffsetTime = document.getElementById('resetOffsetTime');
      window.offsetTime = document.getElementById('offsetTime');
      window.clock = document.getElementById('clock');
      window.offsetStatus = document.getElementById('offsetStatus');
      window.url = document.getElementById('url');

      const updateURLButton = document.getElementById('updateURLButton');
      const copyURLButton = document.getElementById('copyURLButton');
      updateURLButton.addEventListener('click', updateURL);
      copyURLButton.addEventListener('click', copyURL);

      loadParamsFromURL();
      updateTime();

      // 1秒ごとに時刻更新
      setInterval(updateTime, 1000);
    });
  </script>
</body>

</html>